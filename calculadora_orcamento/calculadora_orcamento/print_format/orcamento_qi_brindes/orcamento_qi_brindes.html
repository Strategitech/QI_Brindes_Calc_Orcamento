{#
  ERPNext Print Format: Orçamento QI Brindes
  DocType: Calculadora Orcamento

  KEY DIFFERENCES FROM STANDARD QUOTATION:
  - Single item per document (no items child table)
  - Item linked via doc.item (Link → Item)
  - Customer linked via doc.nome (Link → Customer)
  - Final prices in doc.valor_final_unitario / doc.valor_final_total
  - Frete is a Currency field (doc.frete), not a check
  - Internal fields (commission, BV, tax breakdown) are EXCLUDED from print

  FIELD MAPPING:
  ─────────────────────────────────────────────
  doc.nome                → Customer link
  doc.telefone_whatsapp   → Customer phone
  doc.item                → Item link
  doc.imagem_produto      → User-selected product image
  doc.descrição           → Item description (read-only, fetch_from item.description)
  doc.quantidade          → Qty
  doc.custo_base          → Base cost (internal — not shown)
  doc.valor_final_unitario → Client-facing unit price
  doc.valor_final_total    → Client-facing total
  doc.frete               → Shipping cost
  doc.gravacoes           → Child table of engravings
  doc.total_gravacao      → Sum of engraving costs
#}

{% set customer_doc = frappe.get_doc("Customer", doc.nome) if doc.nome else None %}
{% set item_doc = frappe.get_doc("Item", doc.item) if doc.item else None %}
{% set company_name = frappe.defaults.get_defaults().company %}
{% set company_doc = frappe.get_doc("Company", company_name) if company_name else None %}

{# Resolve product image: user-selected first, then Item.image fallback #}
{% set product_image = doc.imagem_produto or (item_doc.image if item_doc else None) %}

{# Resolve product display name: item_name (never item_code) #}
{% set product_name = item_doc.item_name if item_doc else "" %}

{# Collect engraving methods from child table #}
{% set gravacao_metodos = [] %}
{% for row in doc.gravacoes %}
  {% if row.catalogo_gravacao %}
    {% set metodo = frappe.db.get_value("Catalogo Gravacao", row.catalogo_gravacao, "metodo_gravacao") %}
    {% if metodo and metodo not in gravacao_metodos %}
      {% do gravacao_metodos.append(metodo) %}
    {% endif %}
  {% endif %}
{% endfor %}

<style>
  @page {
    size: A4;
    margin: 15mm 20mm 25mm 20mm;
  }

  body {
    font-family: 'Helvetica Neue', Arial, sans-serif;
    font-size: 10pt;
    color: #333;
    line-height: 1.5;
  }

  .orcamento-wrapper {
    position: relative;
    width: 100%;
    max-width: 700px;
    margin: 0 auto;
  }

  .watermark {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.06;
    z-index: -1;
    pointer-events: none;
  }

  .watermark img {
    max-width: 500px;
    max-height: 500px;
  }

  .header-section {
    text-align: center;
    margin-bottom: 20px;
  }

  .header-section img.company-logo {
    max-height: 90px;
    margin-bottom: 10px;
  }

  .company-info {
    font-size: 9pt;
    color: #555;
    background: #f8f8f8;
    padding: 8px 15px;
    border-radius: 3px;
    margin-bottom: 20px;
    text-align: center;
  }

  .client-section {
    margin-bottom: 15px;
  }

  .client-label {
    font-weight: 700;
    font-size: 10pt;
    color: #222;
  }

  .date-line {
    text-align: right;
    font-size: 10pt;
    color: #444;
    margin-bottom: 10px;
  }

  .greeting {
    font-size: 10pt;
    color: #444;
    margin-bottom: 20px;
  }

  .items-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }

  .items-table thead th {
    background-color: #E87722;
    color: #fff;
    padding: 10px 8px;
    font-size: 9pt;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    text-align: center;
    border: 1px solid #d06a1a;
  }

  .items-table thead th:first-child {
    text-align: left;
    width: 45%;
  }

  .items-table tbody td {
    padding: 12px 8px;
    border: 1px solid #ddd;
    vertical-align: middle;
    font-size: 9.5pt;
  }

  .item-image {
    max-width: 80px;
    max-height: 80px;
    display: block;
    margin: 0 auto 6px auto;
  }

  .item-name {
    font-weight: 600;
    font-size: 9.5pt;
    margin-bottom: 4px;
  }

  .item-description {
    font-size: 9pt;
    color: #555;
    font-style: italic;
  }

  .item-gravacao {
    font-size: 8.5pt;
    color: #E87722;
    margin-top: 4px;
  }

  .text-center { text-align: center; }
  .text-right { text-align: right; }

  .footer-notes {
    margin-top: 25px;
    padding: 12px 15px;
    background: #fdf6f0;
    border-left: 4px solid #E87722;
    border-radius: 0 3px 3px 0;
  }

  .footer-notes p {
    margin: 4px 0;
    font-size: 10pt;
    font-weight: 600;
    color: #333;
  }

  .footer-notes .highlight {
    color: #E87722;
    font-weight: 700;
  }

  .page-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    text-align: center;
    font-size: 8pt;
    color: #E87722;
    border-top: 2px solid #E87722;
    padding-top: 6px;
  }

  .page-footer a {
    color: #E87722;
    text-decoration: none;
    font-weight: 600;
  }
</style>

<div class="orcamento-wrapper">

  {% if company_doc and company_doc.company_logo %}
  <div class="watermark">
    <img src="{{ company_doc.company_logo }}" alt="">
  </div>
  {% endif %}

  <!-- HEADER -->
  <div class="header-section">
    {% if company_doc and company_doc.company_logo %}
      <img class="company-logo" src="{{ company_doc.company_logo }}" alt="{{ company_doc.name }}">
    {% elif company_doc %}
      <h2 style="color: #E87722; margin: 0;">{{ company_doc.name }}</h2>
    {% endif %}
  </div>

  {% if company_doc %}
  <div class="company-info">
    {{ company_doc.name | upper }}
    {% if company_doc.tax_id %} CNPJ: {{ company_doc.tax_id }}{% endif %}
    {% if company_doc.custom_inscricao_estadual %} INSCRI&Ccedil;&Atilde;O ESTADUAL: {{ company_doc.custom_inscricao_estadual }}{% endif %}
  </div>
  {% endif %}

  <!-- CLIENT & DATE -->
  <div class="client-section">
    <span class="client-label">EMPRESA/ SOLICITANTE:</span>
    {{ customer_doc.customer_name if customer_doc else doc.nome }}
  </div>

  <div class="date-line">
    {{ frappe.utils.formatdate(doc.creation, "d 'de' MMMM 'de' yyyy") }}
  </div>

  <div class="greeting">
    Agradecemos sua solicita&ccedil;&atilde;o de or&ccedil;amento, segue nossa cota&ccedil;&atilde;o abaixo:
  </div>

  <!-- SINGLE-ITEM TABLE -->
  <table class="items-table">
    <thead>
      <tr>
        <th>Produto</th>
        <th>Quantidade</th>
        <th>Valor Unit&aacute;rio</th>
        <th>Valor Total</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          {% if product_image %}
            <img class="item-image" src="{{ product_image }}" alt="">
          {% endif %}
          {% if product_name %}
            <div class="item-name">{{ product_name }}</div>
          {% endif %}
          {% set descricao = doc.get("descri\u00e7\u00e3o") or "" %}
          {% if descricao %}
            <div class="item-description">{{ descricao }}</div>
          {% endif %}
          {% if gravacao_metodos %}
            <div class="item-gravacao">Grava&ccedil;&atilde;o: {{ gravacao_metodos | join(", ") }}</div>
          {% endif %}
        </td>
        <td class="text-center">{{ doc.quantidade | int }}</td>
        <td class="text-center">{{ frappe.utils.fmt_money(doc.valor_final_unitario, currency="BRL") }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(doc.valor_final_total, currency="BRL") }}</td>
      </tr>
    </tbody>
  </table>

  <!-- FOOTER NOTES -->
  <div class="footer-notes">
    {% if doc.frete and doc.frete > 0 %}
      <p>FRETE: {{ frappe.utils.fmt_money(doc.frete, currency="BRL") }}</p>
    {% else %}
      <p class="highlight">FRETE N&Atilde;O INCLUSO</p>
    {% endif %}

    <p>Validade do or&ccedil;amento 10 dias</p>
    <p>Prazo de entrega 15 dias &uacute;teis</p>
  </div>

  <!-- PAGE FOOTER -->
  <div class="page-footer">
    <a href="http://www.qibrindes.com.br">www.qibrindes.com.br</a> |
    fone: 11 2476 - 6065 |
    contato@qibrindes.com.br
  </div>

</div>
