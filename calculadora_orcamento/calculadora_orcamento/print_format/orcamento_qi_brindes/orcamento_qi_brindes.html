{% set customer_doc = frappe.get_doc("Customer", doc.nome) if doc.nome else None %}
{% set item_doc = frappe.get_doc("Item", doc.item) if doc.item else None %}
{% set company_name = frappe.db.get_single_value("Global Defaults", "default_company") %}
{% set company_doc = frappe.get_doc("Company", company_name) if company_name else None %}
{% set product_image = doc.imagem_produto or (item_doc.image if item_doc else None) %}
{% set product_name = item_doc.item_name if item_doc and item_doc.item_name else (doc.item or "") %}
{% set descricao = doc.get("descri\u00e7\u00e3o") or "" %}

{% set gravacao_metodos = [] %}
{% for row in doc.gravacoes %}
  {% if row.catalogo_gravacao %}
    {% set metodo = frappe.db.get_value("Catalogo Gravacao", row.catalogo_gravacao, "metodo_gravacao") %}
    {% if metodo and metodo not in gravacao_metodos %}
      {% set _ = gravacao_metodos.append(metodo) %}
    {% endif %}
  {% endif %}
{% endfor %}

<style>
  @page {
    size: A4;
    margin: 14mm 12mm 16mm 12mm;
  }

  body {
    font-family: "Times New Roman", Times, serif;
    font-size: 11pt;
    color: #111;
    line-height: 1.35;
  }

  .quote-page {
    position: relative;
    min-height: 100%;
  }

  .brand-curve {
    position: absolute;
    top: -18mm;
    right: -12mm;
    width: 220mm;
    height: 40mm;
    border-bottom-left-radius: 210mm 40mm;
    border-bottom-right-radius: 0;
    background: linear-gradient(90deg, #ececf3 0%, #ececf3 72%, #223985 73%, #223985 85%, #2f2f8e 100%);
    z-index: 0;
  }

  .watermark {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -44%);
    opacity: 0.1;
    z-index: -1;
    pointer-events: none;
  }

  .watermark img {
    width: 170mm;
    max-width: 90vw;
  }

  .header {
    position: relative;
    z-index: 1;
    margin-top: 2mm;
  }

  .logo {
    max-height: 34mm;
    display: block;
    margin: 0 0 5mm 0;
  }

  .company-strip {
    text-align: center;
    font-size: 9.2pt;
    font-weight: 700;
    letter-spacing: 0.1px;
    margin: 0 0 8mm 0;
  }

  .meta-row {
    margin-bottom: 6mm;
  }

  .requestor {
    font-size: 12pt;
    font-weight: 700;
    margin-bottom: 6mm;
  }

  .quote-date {
    text-align: right;
    font-size: 11pt;
    font-weight: 700;
    margin-bottom: 6mm;
  }

  .intro {
    font-size: 11.5pt;
    font-weight: 700;
    margin-bottom: 9mm;
  }

  .quote-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    margin-bottom: 8mm;
  }

  .quote-table th,
  .quote-table td {
    border: 1px solid #2a2a2a;
    padding: 4px 6px;
    vertical-align: top;
  }

  .quote-table thead th {
    background: #ececec;
    font-style: italic;
    font-size: 11pt;
    font-weight: 400;
    text-align: center;
  }

  .quote-table thead th:first-child {
    width: 52%;
  }

  .quote-table thead th:nth-child(2) {
    width: 18%;
  }

  .quote-table thead th:nth-child(3),
  .quote-table thead th:nth-child(4) {
    width: 15%;
  }

  .product-cell {
    min-height: 120px;
  }

  .product-image {
    display: block;
    max-width: 36mm;
    max-height: 30mm;
    margin: 0 auto 3mm auto;
  }

  .product-text {
    text-align: center;
    font-size: 10pt;
    font-style: italic;
    line-height: 1.2;
  }

  .product-gravacao {
    display: block;
    margin-top: 1mm;
  }

  .center {
    text-align: center;
    vertical-align: middle;
    font-size: 15pt;
    font-style: italic;
  }

  .money {
    text-align: left;
    vertical-align: middle;
    font-size: 15pt;
    font-style: italic;
    white-space: nowrap;
  }

  .notes {
    margin-left: 12mm;
    margin-top: 8mm;
  }

  .notes p {
    margin: 0 0 3mm 0;
    font-size: 10.6pt;
    font-weight: 700;
  }

  .notes .frete {
    text-transform: uppercase;
  }
</style>

<div class="quote-page">
  <div class="brand-curve"></div>

  {% if company_doc and company_doc.company_logo %}
  <div class="watermark">
    <img src="{{ company_doc.company_logo }}" alt="">
  </div>
  {% endif %}

  <div class="header">
    {% if company_doc and company_doc.company_logo %}
      <img class="logo" src="{{ company_doc.company_logo }}" alt="{{ company_doc.name }}">
    {% elif company_doc %}
      <h2 style="margin: 0 0 5mm 0;">{{ company_doc.name }}</h2>
    {% endif %}

    <div class="company-strip">
      {% if company_doc %}
        {{ company_doc.name | upper }}
        {% if company_doc.tax_id %} CNPJ: {{ company_doc.tax_id }}{% endif %}
        {% if company_doc.custom_inscricao_estadual %} INSCRICAO ESTADUAL: {{ company_doc.custom_inscricao_estadual }}{% endif %}
      {% endif %}
    </div>

    <div class="meta-row">
      <div class="requestor">EMPRESA/ SOLICITANTE: {{ customer_doc.customer_name if customer_doc else (doc.nome or "") }}</div>
      <div class="quote-date">Sao Paulo, {{ frappe.utils.formatdate(doc.creation, "d 'de' MMMM 'de' yyyy") }}.</div>
    </div>

    <div class="intro">Agradecemos sua solicitacao de orcamento, segue nossa cotacao abaixo:</div>
  </div>

  <table class="quote-table">
    <thead>
      <tr>
        <th>Produto</th>
        <th>Quantidade</th>
        <th>Valor unitario</th>
        <th>Valor total</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="product-cell">
          {% if product_image %}
            <img class="product-image" src="{{ product_image }}" alt="">
          {% endif %}
          <div class="product-text">
            {{ (product_name ~ (", " ~ descricao if descricao else "")) | replace("\n", " ") }}
            {% if gravacao_metodos %}
              <span class="product-gravacao">personalizada a {{ gravacao_metodos | join(", ") | lower }}</span>
            {% endif %}
          </div>
        </td>
        <td class="center">{{ doc.quantidade | int }}</td>
        <td class="money">{{ frappe.utils.fmt_money(doc.valor_final_unitario, currency="BRL") }}</td>
        <td class="money">{{ frappe.utils.fmt_money(doc.valor_final_total, currency="BRL") }}</td>
      </tr>
    </tbody>
  </table>

  <div class="notes">
    {% if doc.frete and doc.frete > 0 %}
      <p class="frete">FRETE: {{ frappe.utils.fmt_money(doc.frete, currency="BRL") }}</p>
    {% else %}
      <p class="frete">FRETE NAO INCLUSO</p>
    {% endif %}
    <p>Validade do orcamento 10 dias</p>
    <p>Prazo de entrega 15 dias uteis</p>
  </div>
</div>
