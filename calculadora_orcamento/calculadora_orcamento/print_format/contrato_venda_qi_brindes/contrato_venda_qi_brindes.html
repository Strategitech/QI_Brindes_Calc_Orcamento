{% set orc_doc = frappe.get_doc("Calculadora Orcamento", doc.orcamento) if doc.orcamento else None %}
{% set customer_doc = frappe.get_doc("Customer", orc_doc.nome) if orc_doc and orc_doc.nome else None %}

{% set company_name = frappe.db.get_single_value("Global Defaults", "default_company") %}
{% set company_doc = frappe.get_doc("Company", company_name) if company_name else None %}
{% set company_address_name = frappe.db.get_value("Dynamic Link", {
    "link_doctype": "Company",
    "link_name": company_name,
    "parenttype": "Address"
}, "parent") if company_name else None %}
{% set company_addr = frappe.get_doc("Address", company_address_name) if company_address_name else None %}

{% set customer_address_name = frappe.db.get_value("Dynamic Link", {
    "link_doctype": "Customer",
    "link_name": orc_doc.nome,
    "parenttype": "Address"
}, "parent") if orc_doc and orc_doc.nome else None %}
{% set customer_addr = frappe.get_doc("Address", customer_address_name) if customer_address_name else None %}

{% set delivery_parts = [] %}
{% if doc.endereco_logradouro %}{% set _ = delivery_parts.append(doc.endereco_logradouro) %}{% endif %}
{% if doc.endereco_complemento %}{% set _ = delivery_parts.append(doc.endereco_complemento) %}{% endif %}
{% if doc.endereco_bairro %}{% set _ = delivery_parts.append(doc.endereco_bairro) %}{% endif %}
{% if doc.endereco_cidade and doc.endereco_estado %}
  {% set _ = delivery_parts.append(doc.endereco_cidade ~ " - " ~ doc.endereco_estado) %}
{% elif doc.endereco_cidade %}
  {% set _ = delivery_parts.append(doc.endereco_cidade) %}
{% endif %}
{% if doc.endereco_cep %}{% set _ = delivery_parts.append("CEP " ~ doc.endereco_cep) %}{% endif %}
{% set delivery_address = delivery_parts | join(", ") if delivery_parts else None %}

{% set estimated_delivery = frappe.utils.add_days(doc.data_confirmacao, 15) if doc.data_confirmacao else None %}

<style>
  @page {
    size: A4;
    margin: 13mm 12mm 16mm 12mm;
  }

  body {
    font-family: "Times New Roman", Times, serif;
    font-size: 11pt;
    color: #111;
    line-height: 1.3;
  }

  .contract-page {
    position: relative;
  }

  .watermark {
    position: fixed;
    top: 53%;
    left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.1;
    z-index: -1;
    pointer-events: none;
  }

  .watermark img {
    width: 170mm;
    max-width: 90vw;
  }

  .logo {
    max-height: 28mm;
    margin-bottom: 4mm;
  }

  .title {
    text-align: center;
    font-size: 15.5pt;
    font-weight: 700;
    line-height: 1.15;
    margin: 0 0 5mm 0;
    text-transform: uppercase;
  }

  .section-title {
    border: 1px solid #4a4a4a;
    text-align: center;
    font-weight: 700;
    font-size: 12pt;
    padding: 1.2mm 0;
    margin: 5mm 0 4mm 0;
    text-transform: uppercase;
  }

  p {
    margin: 2.2mm 0;
    text-align: justify;
  }

  .label {
    font-weight: 700;
  }

  .contract-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    margin-top: 2mm;
    margin-bottom: 4mm;
  }

  .contract-table th,
  .contract-table td {
    border: 1px solid #454545;
    padding: 2.2mm 2.4mm;
    vertical-align: top;
  }

  .contract-table th {
    background: #efefef;
    color: #111;
    text-align: left;
    font-size: 10.2pt;
    font-weight: 700;
    text-transform: uppercase;
  }

  .contract-table th:nth-child(1) { width: 45%; }
  .contract-table th:nth-child(2) { width: 17%; }
  .contract-table th:nth-child(3) { width: 19%; }
  .contract-table th:nth-child(4) { width: 19%; }

  .contract-table td {
    min-height: 28mm;
    font-size: 10.5pt;
  }

  .center { text-align: center; }
  .money { text-align: right; }

  .summary {
    margin: 0 0 4mm 0;
    padding: 0;
    list-style: none;
  }

  .summary li {
    margin: 1.2mm 0;
    font-size: 12pt;
    font-weight: 700;
  }

  .summary li:before {
    content: "\27A4\00A0";
  }

  .summary .value {
    font-weight: 400;
  }

  .obs {
    background: #fff36b;
    padding: 2.4mm 2.8mm;
    border: 1px solid #d3c94f;
    font-size: 10.8pt;
    margin: 3mm 0 5mm 0;
  }

  .obs p {
    margin: 0.8mm 0;
  }

  .obs .obs-title {
    font-weight: 700;
  }

  .clause-heading {
    font-size: 12pt;
    font-weight: 700;
    margin: 4mm 0 1.5mm 0;
    text-transform: uppercase;
  }

  .clause-text {
    margin: 1.2mm 0;
    text-align: justify;
    font-size: 10.8pt;
    line-height: 1.3;
  }

  .clause-subitem {
    margin-left: 6mm;
  }

  .clause-list {
    margin: 1mm 0 2mm 8mm;
    padding-left: 4mm;
  }

  .clause-list li {
    margin: 1.2mm 0;
    text-align: justify;
    font-size: 10.8pt;
  }

  .signature-section {
    margin-top: 8mm;
  }

  .signature-date {
    text-align: right;
    margin-bottom: 12mm;
    font-size: 11pt;
  }

  .signature-block {
    margin-bottom: 11mm;
  }

  .signature-block .sig-label {
    font-size: 11pt;
    font-weight: 700;
    margin-bottom: 6mm;
  }

  .signature-line {
    width: 92mm;
    border-bottom: 1px solid #222;
    padding-bottom: 1mm;
    font-size: 10.8pt;
  }

  .footer {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    text-align: center;
    font-size: 9.8pt;
    color: #333;
  }

  .footer strong {
    font-weight: 700;
  }

  .page-break {
    page-break-before: always;
  }
</style>

<div class="contract-page">
  {% if company_doc and company_doc.company_logo %}
  <div class="watermark">
    <img src="{{ company_doc.company_logo }}" alt="">
  </div>
  {% endif %}

  {% if company_doc and company_doc.company_logo %}
    <img class="logo" src="{{ company_doc.company_logo }}" alt="{{ company_doc.name }}">
  {% elif company_doc %}
    <h2 style="margin: 0 0 4mm 0;">{{ company_doc.name }}</h2>
  {% endif %}

  <div class="title">Contrato de Venda de Produtos<br>Personalizados</div>

  <div class="section-title">Partes:</div>

  <p>
    <span class="label">CONTRATADA:</span>
    {% if company_doc %}
      {{ company_doc.name }}, inscrita no CNPJ sob o numero {{ company_doc.tax_id or "_______________" }}
      {% if company_doc.custom_inscricao_estadual %}, com Inscricao Estadual {{ company_doc.custom_inscricao_estadual }}{% endif %}
      {% if company_doc.custom_ccm %} e C.C.M. {{ company_doc.custom_ccm }}{% endif %}
      {% if company_addr %}, com endereco {{ company_addr.address_line1 }}{% if company_addr.address_line2 %} - {{ company_addr.address_line2 }}{% endif %}, {{ company_addr.city }} - {{ company_addr.state }}, {{ company_addr.pincode }}{% endif %}.
    {% endif %}
  </p>

  <p>
    <span class="label">CONTRATANTE:</span>
    {{ doc.cliente }}
    {% if customer_doc and customer_doc.tax_id %}, inscrito(a) no CNPJ/CPF sob o numero {{ customer_doc.tax_id }}{% endif %}
    {% if customer_addr %}, com endereco {{ customer_addr.address_line1 }}{% if customer_addr.address_line2 %} - {{ customer_addr.address_line2 }}{% endif %}, {{ customer_addr.city }} - {{ customer_addr.state }}, {{ customer_addr.pincode }}{% endif %}
    {% if doc.telefone %}, contato: {{ doc.telefone }}{% endif %}.
  </p>

  <div class="section-title">Dados da Compra</div>

  <table class="contract-table">
    <thead>
      <tr>
        <th>Produto</th>
        <th>Quantidade</th>
        <th>Valor Unitario</th>
        <th>Valor Total</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ doc.item }}{% if doc.descricao %}<br><small>{{ doc.descricao }}</small>{% endif %}</td>
        <td class="center">{{ doc.quantidade | int }}</td>
        <td class="money">{{ frappe.utils.fmt_money(doc.valor_unitario, currency="BRL") }}</td>
        <td class="money">{{ frappe.utils.fmt_money(doc.valor_total, currency="BRL") }}</td>
      </tr>
    </tbody>
  </table>

  <ul class="summary">
    <li>Valor do Frete: <span class="value">{% if orc_doc and orc_doc.frete and orc_doc.frete > 0 %}{{ frappe.utils.fmt_money(orc_doc.frete, currency="BRL") }}{% else %}A calcular{% endif %}</span></li>
    <li>Valor Total Do Pedido: <span class="value">{{ frappe.utils.fmt_money(doc.valor_total, currency="BRL") }}</span></li>
    <li>Endereco De Entrega: <span class="value">{{ delivery_address if delivery_address else "[campo editavel]" }}</span></li>
    <li>Data De Confirmacao: <span class="value">{% if doc.data_confirmacao %}{{ frappe.utils.formatdate(doc.data_confirmacao, "dd/MM/yyyy") }}{% else %}[campo editavel]{% endif %}</span></li>
    <li>Data De Entrega: <span class="value">{% if estimated_delivery %}{{ frappe.utils.formatdate(estimated_delivery, "dd/MM/yyyy") }}{% else %}[campo editavel]{% endif %}</span></li>
  </ul>

  <div class="obs">
    <p class="obs-title">OBS:</p>
    <p>Entrega de entrega at&eacute; 15 dias corridos, sendo o pagamento a vista.</p>
    <p>Em caso de cancelamento ap&oacute;s o in&iacute;cio da produ&ccedil;&atilde;o, ser&aacute; faturado 100% do valor total do pedido, conforme clausulas abaixo.</p>
    {% if doc.observacoes %}
      <p>{{ doc.observacoes }}</p>
    {% endif %}
  </div>

  <div class="section-title">Clausulas do Objeto do Contrato:</div>

  <p class="clause-heading">1. Do Objeto do Contrato</p>
  <p class="clause-text">1.1. O presente contrato tem por objeto a compra e venda de produtos personalizados com a logomarca ou informa&ccedil;&otilde;es especificadas pela CONTRATANTE, conforme descrito no pedido aprovado.</p>

  <p class="clause-heading">2. Do Prazo de Entrega e Responsabilidade Pelo Transporte</p>
  <p class="clause-text">2.1. O prazo de entrega informado durante o procedimento de compra considera estoque, regi&atilde;o, processo de emiss&atilde;o de nota fiscal e prepara&ccedil;&atilde;o do produto.</p>
  <p class="clause-text">2.2. O frete ser&aacute; calculado com base no local de entrega, peso e dimens&otilde;es do produto.</p>
  <p class="clause-text">2.3. A CONTRATADA n&atilde;o se responsabiliza por atrasos causados pela transportadora. Em caso de reten&ccedil;&atilde;o de mercadorias na SEFAZ por pend&ecirc;ncias do CONTRATANTE, caber&aacute; a este realizar os procedimentos necess&aacute;rios para libera&ccedil;&atilde;o.</p>

  <p class="clause-heading">3. Da Producao e Personalizacao dos Produtos</p>
  <p class="clause-text">3.1. Uma vez aprovado o pedido, n&atilde;o ser&aacute; poss&iacute;vel cancel&aacute;-lo, devido &agrave; natureza personalizada dos produtos, a qual a empresa n&atilde;o poder&aacute; revender o mesmo produto por ser personalizado.</p>
  <p class="clause-text">3.2. As cores do pantone podem variar em processos como transferir, grava&ccedil;&atilde;o digital e sublima&ccedil;&atilde;o, apresentando tonalidade aproximada.</p>
  <p class="clause-text">3.3. Produtos personalizados, nome a nome, devem ser acompanhados de lista enviada em formato Word, com a fonte especificada. N&atilde;o h&aacute; altera&ccedil;&atilde;o na grafia, mesmo em casos de erros evidentes.</p>
  <p class="clause-text">3.4. Caso haja desist&ecirc;ncia do CONTRATANTE ap&oacute;s o in&iacute;cio da produ&ccedil;&atilde;o, ser&aacute; obrigat&oacute;rio o pagamento integral do pedido.</p>
  <p class="clause-text">3.5. A CONTRATADA se compromete a seguir as especifica&ccedil;&otilde;es fornecidas pela CONTRATANTE, desde que tecnicamente vi&aacute;veis. Caso alguma especifica&ccedil;&atilde;o n&atilde;o seja poss&iacute;vel, a CONTRATANTE ser&aacute; informada para ajustes ou substitui&ccedil;&atilde;o de materiais.</p>

  <div class="page-break"></div>

  {% if company_doc and company_doc.company_logo %}
    <img class="logo" src="{{ company_doc.company_logo }}" alt="{{ company_doc.name }}">
  {% endif %}

  <p class="clause-heading">4. Das Formas de Pagamento</p>
  <p class="clause-text">4.1. O pagamento poder&aacute; ser realizado &agrave; vista ou de forma parcelada, conforme as op&ccedil;&otilde;es abaixo:</p>
  <p class="clause-text"><strong>Pagamento &agrave; vista:</strong> boleto banc&aacute;rio, d&eacute;bito em conta ou cart&atilde;o de cr&eacute;dito, com acr&eacute;scimo de 5%.</p>
  <p class="clause-text"><strong>Pagamento parcelado:</strong> boleto banc&aacute;rio.</p>
  <p class="clause-text">4.2. A confirma&ccedil;&atilde;o do pagamento &eacute; condi&ccedil;&atilde;o indispens&aacute;vel para in&iacute;cio da produ&ccedil;&atilde;o.</p>
  <p class="clause-text">4.3. Em caso de inadimpl&ecirc;ncia, incidir&atilde;o multa de 20% (vinte por cento) sobre o valor devido, juros de mora de 1% (um por cento) ao m&ecirc;s e corre&ccedil;&atilde;o monet&aacute;ria pelo &iacute;ndice do IPCA.</p>
  <p class="clause-text">4.4. Em caso de n&atilde;o pagamento dos produtos j&aacute; confeccionados, a CONTRATADA poder&aacute;:</p>
  <p class="clause-text clause-subitem">a) Entrar com a&ccedil;&atilde;o judicial para cobranca do valor devido na nota fiscal;</p>
  <p class="clause-text clause-subitem">b) Exigir o pagamento do valor do produto confeccionado, acrescido dos custos com transportadora ou correios, corrigidos com juros de mora de 1% (um por cento) ao m&ecirc;s e multa de 20% (vinte por cento) sobre o valor total;</p>
  <p class="clause-text clause-subitem">c) Requerer o pagamento de honor&aacute;rios advocat&iacute;cios, no percentual de 15% (quinze por cento) sobre o montante devido;</p>
  <p class="clause-text clause-subitem">d) Exigir os pagamentos das custas judiciais.</p>

  <p class="clause-heading">5. Da Alteracao de Pedido e Entrega</p>
  <p class="clause-text">5.1. Ap&oacute;s a finaliza&ccedil;&atilde;o do pedido, n&atilde;o ser&aacute; poss&iacute;vel alterar a forma de pagamento, endere&ccedil;o de entrega ou solicitar prioridade na entrega.</p>
  <p class="clause-text">5.2. Caso o CONTRATANTE solicite modifica&ccedil;&otilde;es antes do in&iacute;cio da produ&ccedil;&atilde;o, estas estar&atilde;o sujeitas &agrave; aprovac&atilde;o e revis&atilde;o dos custos, podendo implicar no ajuste de valores e prazos.</p>

  <p class="clause-heading">6. Do Caso Fortuito e Forca Maior</p>
  <p class="clause-text">6.1. Nenhuma das partes ser&aacute; responsabilizada por falhas ou atrasos decorrentes de eventos de caso fortuito ou for&ccedil;a maior, conforme disposto no art. 393 do C&oacute;digo Civil Brasileiro.</p>

  <p class="clause-heading">7. Das Obrigacoes das Partes</p>
  <p class="clause-text"><strong>7.1. Obrigacoes da CONTRATADA:</strong></p>
  <ul class="clause-list">
    <li>Produzir os produtos conforme as especifica&ccedil;&otilde;es aprovadas no pedido.</li>
    <li>Informar ao CONTRATANTE qualquer impossibilidade de cumprimento das especifica&ccedil;&otilde;es acordadas.</li>
    <li>Garantir a qualidade dos materiais utilizados.</li>
    <li>Disponibilizar suporte para esclarecimento de d&uacute;vidas durante o processo de compra e produ&ccedil;&atilde;o.</li>
  </ul>

  <p class="clause-text"><strong>7.2. Obrigacoes da CONTRATANTE:</strong></p>
  <ul class="clause-list">
    <li>Fornecer informa&ccedil;&otilde;es claras e precisas sobre os dados de personaliza&ccedil;&atilde;o.</li>
    <li>Realizar o pagamento nos termos e prazos acordados.</li>
    <li>Revisar cuidadosamente o pedido antes da aprova&ccedil;&atilde;o final, estando ciente de que n&atilde;o ser&atilde;o realizadas alterac&otilde;es ap&oacute;s este momento.</li>
    <li>Garantir que os dados fornecidos est&atilde;o corretos e completos, especialmente em relac&atilde;o &agrave; grafia e formatac&atilde;o.</li>
  </ul>

  <p class="clause-heading">8. Dos Dados Bancarios da Contratada</p>
  <p class="clause-text">{% if company_doc %}{{ company_doc.name | upper }}{% endif %}, CNPJ: {{ company_doc.tax_id if company_doc else "&mdash;" }}:</p>
  <p class="clause-text clause-subitem">1. Banco 237 - Bradesco - ag&ecirc;ncia 2622 Conta Corrente: 39191-3 Chave Pix: 31.201.696/0001-48, Email: financeiro@qibrindes.com.br.</p>
  <p class="clause-text clause-subitem">2. banco 336 banco C6 S.A. - ag&ecirc;ncia 0001 - conta corrente 32979583-0.</p>
  <p class="clause-text clause-subitem">3. Chave pix: financeiro@qibrindes.com.br</p>

  <p class="clause-heading">9. Do Foro</p>
  <p class="clause-text">9.1. As partes elegem o foro da comarca de {% if company_addr %}{{ company_addr.city }}{% else %}Santana{% endif %}, S&atilde;o Paulo para dirimir quaisquer d&uacute;vidas oriundas deste contrato, com ren&uacute;ncia a qualquer outro, por mais privilegiado que seja.</p>

  <div class="signature-section">
    <div class="signature-date">
      local e data:
      {% if doc.data_confirmacao %}
        {% if company_addr %}{{ company_addr.city }}{% else %}S&atilde;o Paulo{% endif %}, {{ frappe.utils.formatdate(doc.data_confirmacao, "d 'de' MMMM 'de' yyyy") }}.
      {% else %}
        [campo editavel].
      {% endif %}
    </div>

    <div class="signature-block">
      <div class="sig-label">CONTRATADA: {{ company_doc.name if company_doc else "" }}</div>
      <div class="signature-line">Representante:</div>
    </div>

    <div class="signature-block">
      <div class="sig-label">CONTRATANTE:</div>
      <div class="signature-line">Representante:</div>
    </div>
  </div>

  <div class="footer">
    {% if company_doc %}
      <div>
        <strong>{{ company_doc.name }}</strong>
        {% if company_doc.tax_id %} | CNPJ: {{ company_doc.tax_id }}{% endif %}
        {% if company_doc.custom_inscricao_estadual %} | IE: {{ company_doc.custom_inscricao_estadual }}{% endif %}
        {% if company_doc.custom_ccm %} | CCM: {{ company_doc.custom_ccm }}{% endif %}
      </div>
    {% endif %}
    <strong>www.qibrindes.com.br</strong> | fone: 11 2476 - 6065 | contato@qibrindes.com.br
  </div>
</div>
